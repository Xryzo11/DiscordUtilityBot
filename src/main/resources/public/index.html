<!DOCTYPE html>
<script src="https://cdn.jsdelivr.net/npm/js-sha512@0.8.0/src/sha512.min.js"></script>
<script>
    let authEnabled = false;
    let hashedPassword = 'hashedPassword';
    let hashedInput = 'hashedInput';
    fetch('/web-auth')
        .then(res => res.json())
        .then(data => {
            authEnabled = data.enabled;
            if (data.enabled) {
                let password = prompt('Enter WebAuth Password:');
                hashedPassword = data.password;
                hashedInput = sha512(password);
                checkAuth();
            } else {
                console.log('WebAuth not enabled, proceeding.');
            }
        })
        .catch(err => {
            console.error('Error loading web auth config:', err);
            checkAuth();
        });
    function checkAuth() {
        if (authEnabled && hashedInput !== hashedPassword) {
            authEnabled = true;
            hashedPassword = 'hashedPassword';
            hashedInput = 'hashedInput';
            alert('Access denied.');
            window.location.href = 'index.html';
            document.write('<h1 style="font-size:100px">Access Denied</h1>');
            document.write('<input type="button" value="Reload" style="background-color: #3498db; color: #fff; width:250px; height:100px; margin:auto; font-size:50px;" onclick="window.location.reload()">');
            window.stop();
            document.execCommand('Stop');
            document.write('<style type="text/undefined">');
        }
    }
</script>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Bot Control Panel</title>
        <link rel="stylesheet" href="style.css">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
    </head>
    <body>
        <h1>Toggle Features</h1>

        <form id="wywozForm" action="/toggle-wywoz" method="post">
            <label>
                <input type="checkbox" name="status" value="true" onchange="this.form.submit()"
                       id="wywozSmieciToggle">
                Toggle "Auto-Kick"
            </label>
        </form>

        <form id="tempRoleForm" action="/toggle-temp-role-status" method="post">
            <label>
                <input type="checkbox" name="status" value="true" onchange="this.form.submit()"
                       id="tempRoleToggle">
                Toggle "Temp Role"
            </label>
        </form>

        <form id="debugForm" action="/toggle-debug" method="post">
            <label>
                <input type="checkbox" name="status" value="true" onchange="this.form.submit()"
                       id="debugToggle">
                Toggle "Debug"
            </label>
        </form>

        <h2>Auto-Kick Manager</h2>
        <table border="1" id="bindingsTable">
            <thead>
            <tr>
                <th>User ID</th>
                <th>Channel ID</th>
                <th>Enabled</th>
                <th>Remove</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3 id="newBindingTxt">New Auto-Kick</h3>
        <form id="addBindingForm">
            <input type="text" name="userId" placeholder="User ID" required>
            <input type="text" name="channelId" placeholder="Channel ID" required>
            <button type="submit">Add</button>
        </form>

        <h2>Temporary Role Manager</h2>
        <table border="1" id="rolesTable">
            <thead>
            <tr>
                <th>Role ID</th>
                <th>Channel ID</th>
                <th>Enabled</th>
                <th>Remove</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3 id="newRoleTxt">New Temporary Role</h3>
        <form id="addRoleForm">
            <input type="text" name="roleId" placeholder="Role ID" required>
            <input type="text" name="channelId" placeholder="Channel ID" required>
            <button type="submit">Add</button>
        </form>

        <h2>Force restart bot</h2>
        <form action="/force-restart" method="post">
            <button type="submit">Restart Bot</button>
        </form>

        <h2>Bot Information</h2>
        <form>
            <p><b>File name:</b> <span id="fileName"></span></p>
            <p><b>Last restart:</b> <span id="lastRestart"></span></p>
        </form>

        <script>
            fetch('/wywoz-initial-status')
                .then(res => res.text())
                .then(status => {
                    if (status === 'disabled') {
                        document.getElementById('wywozForm').style.display = 'none';
                        document.getElementById('bindingsTable').style.display = 'none';
                        document.getElementById('addBindingForm').style.display = 'none';
                        document.getElementById('newBindingTxt').innerHTML = 'Auto-Kick is disabled';
                    }
                });

            fetch('/wywoz-status')
                .then(res => res.text())
                .then(status => {
                    document.getElementById('wywozSmieciToggle').checked = (status === 'enabled');
                    if (status === 'disabled') {
                        document.getElementById('bindingsTable').style.display = 'none';
                        document.getElementById('addBindingForm').style.display = 'none';
                        document.getElementById('newBindingTxt').innerHTML = 'Auto-Kick is disabled';
                    } else {
                        document.getElementById('bindingsTable').style.display = 'table';
                        document.getElementById('addBindingForm').style.display = 'auto';
                        document.getElementById('newBindingTxt').innerHTML = 'New Auto-Kick';
                    }
                });

            fetch('/temp-role-initial-status')
                .then(res => res.text())
                .then(status => {
                    if (status === 'disabled') {
                        document.getElementById('tempRoleForm').style.display = 'none';
                        document.getElementById('rolesTable').style.display = 'none';
                        document.getElementById('addRoleForm').style.display = 'none';
                        document.getElementById('newRoleTxt').innerHTML = 'Temp Role is disabled';
                    }
                });
            fetch('/temp-role-status')
                .then(res => res.text())
                .then(status => {
                    document.getElementById('tempRoleToggle').checked = (status === 'enabled');
                    if (status === 'disabled') {
                        document.getElementById('rolesTable').style.display = 'none';
                        document.getElementById('addRoleForm').style.display = 'none';
                        document.getElementById('newRoleTxt').innerHTML = 'Temp Role is disabled';
                    } else {
                        document.getElementById('rolesTable').style.display = 'table';
                        document.getElementById('addRoleForm').style.display = 'auto';
                        document.getElementById('newRoleTxt').innerHTML = 'New Temporary Role';
                    }
                });

            fetch('/debug-status')
                .then(res => res.text())
                .then(status => {
                    document.getElementById('debugToggle').checked = (status === 'enabled');
                });

            function loadBindings() {
                fetch('/bindings-detailed')
                    .then(res => res.json())
                    .then(bindings => {
                        const tbody = document.getElementById('bindingsTable').querySelector('tbody');
                        tbody.innerHTML = '';
                        bindings.forEach(b => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${b.userName}<br>(${b.userId})</td>
                                <td>${b.channelName}<br>(${b.channelId})</td>
                                <td>
                                    <input type="checkbox" ${b.enabled ? 'checked' : ''} onchange="toggleBinding('${b.userId}', '${b.channelId}', this.checked)">
                                </td>
                                <td>
                                    <button onclick="removeBinding('${b.userId}', '${b.channelId}')">Remove</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    });
            }

            function toggleBinding(userId, channelId, enabled) {
                console.log('Toggling:', userId, channelId, enabled);
                fetch('/toggle-binding', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `userId=${userId}&channelId=${channelId}&enabled=${enabled}`
                }).then(loadBindings);
            }

            function removeBinding(userId, channelId) {
                fetch('/remove-binding', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `userId=${userId}&channelId=${channelId}`
                }).then(loadBindings);
            }

            document.getElementById('addBindingForm').onsubmit = function(e) {
                e.preventDefault();
                const form = e.target;
                const userId = form.userId.value;
                const channelId = form.channelId.value;
                fetch('/add-binding', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `userId=${userId}&channelId=${channelId}`
                }).then(() => {
                    form.reset();
                    loadBindings();
                });
            };
            loadBindings();

            function loadTempRoles() {
                fetch('/temp-roles-detailed')
                    .then(res => res.json())
                    .then(bindings => {
                        const tbody = document.getElementById('rolesTable').querySelector('tbody');
                        tbody.innerHTML = '';
                        bindings.forEach(b => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${b.roleName}<br>(${b.roleId})</td>
                                <td>${b.channelName}<br>(${b.channelId})</td>
                                <td>
                                    <input type="checkbox" ${b.enabled ? 'checked' : ''} onchange="toggleTempRole('${b.roleId}', '${b.channelId}', this.checked)">
                                </td>
                                <td>
                                    <button onclick="removeTempRole('${b.roleId}', '${b.channelId}')">Remove</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    });
            }
            loadTempRoles();

            function toggleTempRole(roleId, channelId, enabled) {
                console.log('Toggling:', roleId, channelId, enabled);
                fetch('/toggle-temp-role', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `roleId=${roleId}&channelId=${channelId}&enabled=${enabled}`
                }).then(loadTempRoles);
            }

            document.getElementById('addRoleForm').onsubmit = function(e) {
                e.preventDefault();
                const form = e.target;
                const roleId = form.roleId.value;
                const channelId = form.channelId.value;
                fetch('/add-temp-role', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `roleId=${roleId}&channelId=${channelId}`
                }).then(() => {
                    form.reset();
                    loadTempRoles();
                });
            };

            function removeTempRole(roleId, channelId) {
                fetch('/remove-temp-role', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `roleId=${roleId}&channelId=${channelId}`
                }).then(loadTempRoles);
            }

            fetch('/get-info')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('fileName').innerHTML= data.fullVersion;
                    document.getElementById('lastRestart').innerHTML = data.lastRestart;
                })
                .catch(err => {
                    document.getElementById('fileName').innerHTML= "Error loading info - " + err.message;
                    document.getElementById('lastRestart').innerHTML = "Error loading info - " + err.message;
                });
        </script>
    </body>
</html>
